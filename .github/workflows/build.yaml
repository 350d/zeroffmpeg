name: Build FFmpeg for Pi Zero v6.1
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Download dockcross wrapper
        run: docker run --rm dockcross/linux-armv6 > ./dockcross

      - run: chmod +x dockcross build_ffmpeg.sh

      - name: Install build dependencies in dockcross
        run: |
          ./dockcross bash -lc "apt-get update && apt-get install -y --no-install-recommends \
          git pkg-config build-essential yasm libssl-dev libv4l-dev v4l-utils libdrm-dev zlib1g-dev \
          libjpeg-dev libpng-dev libx264-dev libavcodec-dev libavformat-dev libavfilter-dev \
          libavutil-dev libswscale-dev libswresample-dev \
          && rm -rf /var/lib/apt/lists/*"
      - name: Check for libv4l2.pc
        run: ./dockcross bash -lc "ls /usr/lib/pkgconfig/libv4l2.pc"
      
      - name: Build inside dockcross
        run: ./dockcross ./build_ffmpeg.sh

      - uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-armv6
          path: ffmpeg-armv6.tar.gz
