name: Build FFmpeg for Pi Zero

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: dockcross/linux-armv6:latest
      options: --platform linux/amd64  # Ensure container runs on x86_64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
          automake \
          autoconf \
          build-essential \
          ccache \
          cmake \
          git \
          libasound2-dev \
          libdrm-dev \
          libgnutls28-dev \
          libjpeg-dev \
          libssl-dev \
          libv4l-dev \
          libx264-dev \
          libtool \
          make \
          nasm \
          openssl \
          pkg-config \
          sudo \
          yasm \
          zlib1g-dev

      - name: Setup environment
        run: |
          # Set up sysroot directories with proper permissions
          sudo mkdir -p /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib
          sudo mkdir -p /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/include
          sudo mkdir -p /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig
          sudo chmod -R 777 /usr/xcc/armv6-unknown-linux-gnueabihf

          # Set up pkg-config
          echo "=== Setting up pkg-config ==="
          export PKG_CONFIG_PATH="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
          export PKG_CONFIG_LIBDIR="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
          export PKG_CONFIG_SYSROOT_DIR="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot"

          # Debug information
          echo "=== System Information ==="
          uname -a
          echo "=== Compiler Information ==="
          ${CROSS_COMPILE}gcc --version
          echo "=== PKG Config Information ==="
          pkg-config --version
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
          echo "PKG_CONFIG_LIBDIR=$PKG_CONFIG_LIBDIR"
          echo "PKG_CONFIG_SYSROOT_DIR=$PKG_CONFIG_SYSROOT_DIR"
          echo "=== Environment Variables ==="
          env | sort
          echo "=== Directory Structure ==="
          ls -la /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/
          ls -la /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/include/
          ls -la /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig/

      - name: Make build script executable
        run: |
          chmod +x build_ffmpeg.sh

      - name: Run cross-compilation
        run: |
          export PKG_CONFIG_PATH="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
          export PKG_CONFIG_LIBDIR="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
          export PKG_CONFIG_SYSROOT_DIR="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot"
          export PKG_CONFIG_DEBUG_SPEW=1
          ./build_ffmpeg.sh

      - name: Check build artifacts
        run: |
          ls -la /__w/zeroffmpeg/install/bin/
          file /__w/zeroffmpeg/install/bin/ffmpeg
          ${CROSS_COMPILE}readelf -h /__w/zeroffmpeg/install/bin/ffmpeg
          ldd /__w/zeroffmpeg/install/bin/ffmpeg || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-armv6-static
          path: /__w/zeroffmpeg/install/bin/
          if-no-files-found: error
