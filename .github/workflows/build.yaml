name: Build FFmpeg for Pi Zero

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: dockcross/linux-armv6:latest
      options: --platform linux/amd64  # Ensure container runs on x86_64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            pkg-config \
            zlib1g-dev \
            libasound2-dev \
            nasm \
            yasm \
            make \
            automake \
            autoconf \
            libtool

      - name: Setup environment
        run: |
          echo "=== System Information ==="
          uname -a
          echo "=== Compiler Information ==="
          ${CROSS_COMPILE}gcc --version
          echo "=== PKG Config Information ==="
          pkg-config --version
          echo "=== Environment Variables ==="
          env | sort
          echo "=== Current Directory Structure ==="
          pwd
          ls -la
          echo "=== Cross Compiler Directory ==="
          ls -la /usr/xcc/arm-linux-gnueabi/

      - name: Make build script executable
        run: chmod +x build_ffmpeg.sh

      - name: Run cross-compilation
        run: |
          export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig"
          export PKG_CONFIG_LIBDIR="/usr/xcc/arm-linux-gnueabi/lib/pkgconfig"
          ./build_ffmpeg.sh

      - name: Check build artifacts
        run: |
          ls -la install/bin/
          file install/bin/ffmpeg
          ${CROSS_COMPILE}readelf -h install/bin/ffmpeg
          ldd install/bin/ffmpeg || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-armv6-static
          path: install/bin/
          if-no-files-found: error
