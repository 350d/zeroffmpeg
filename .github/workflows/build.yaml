name: Build FFmpeg for Pi Zero v6.3
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Download dockcross wrapper
        run: |
          docker run --rm dockcross/linux-armv6 > ./dockcross
          chmod +x ./dockcross

      # Шаг для «тихой» настройки Ubuntu-источников только под amd64
      - name: Restrict Ubuntu repos to amd64 only
        run: |
          # Ubuntu runner использует Mirrorlist в /etc/apt/apt-mirrors.txt
          sudo sed -i -E 's|^deb |deb [arch=amd64] |' /etc/apt/apt-mirrors.txt
          # на всякий случай поправим /etc/apt/sources.list тоже
          sudo sed -i -E 's|^deb |deb [arch=amd64] |' /etc/apt/sources.list

      - name: Enable armhf & add Debian Bookworm armhf repos
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends gnupg dirmngr debian-archive-keyring

          # установили ключи, скопируем их в доверенные
          sudo cp /usr/share/keyrings/debian-archive-keyring.gpg /etc/apt/trusted.gpg.d/

          sudo dpkg --add-architecture armhf

          sudo tee /etc/apt/sources.list.d/bookworm-armhf.list <<EOF
          deb [arch=armhf signed-by=/etc/apt/trusted.gpg.d/debian-archive-keyring.gpg] http://deb.debian.org/debian bookworm main
          deb [arch=armhf signed-by=/etc/apt/trusted.gpg.d/debian-archive-keyring.gpg] http://security.debian.org/debian-security bookworm-security main
          deb [arch=armhf signed-by=/etc/apt/trusted.gpg.d/debian-archive-keyring.gpg] http://deb.debian.org/debian bookworm-updates main
          EOF

          sudo apt-get update

      - name: Fetch & unpack ARM dev-packages
        env:
          SYSROOT: /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot
        run: |
          PKGS=(
            libv4l-dev:armhf
            libdrm-dev:armhf
            zlib1g-dev:armhf
            libssl-dev:armhf
            libx264-dev:armhf
            libjpeg-dev:armhf
            libpng-dev:armhf
          )

          # скачиваем только armhf-пакеты из Debian Bookworm
          apt-get download "${PKGS[@]}"

          mkdir -p "$SYSROOT/usr/lib/arm-linux-gnueabihf/pkgconfig"
          for DEB in *.deb; do
            TMP=$(mktemp -d)
            dpkg-deb -x "$DEB" "$TMP"
            cp "$TMP/usr/lib/arm-linux-gnueabihf/pkgconfig/"*.pc \
               "$SYSROOT/usr/lib/arm-linux-gnueabihf/pkgconfig/" 2>/dev/null || true
            rm -rf "$TMP"
          done

      - name: Make build script executable
        run: chmod +x build_ffmpeg.sh

      - name: Build FFmpeg inside dockcross
        run: ./dockcross ./build_ffmpeg.sh

      - uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-armv6
          path: ffmpeg-armv6.tar.gz