name: Build FFmpeg for Pi Zero

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: dockcross/linux-armv6:latest
      options: --platform linux/amd64  # Ensure container runs on x86_64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
          automake \
          autoconf \
          build-essential \
          ccache \
          cmake \
          git \
          libasound2-dev \
          libdrm-dev \
          libgnutls28-dev \
          libjpeg-dev \
          libssl-dev \
          libv4l-dev \
          libx264-dev \
          libtool \
          make \
          nasm \
          openssl \
          pkg-config \
          sudo \
          yasm \
          zlib1g-dev

      - name: Setup environment
        run: |
          # Set up sysroot directories
          mkdir -p /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/{lib,include,lib/pkgconfig}
          chmod -R 777 /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot

          # Copy OpenSSL files to sysroot
          cp -r /usr/include/openssl /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/include/
          cp /usr/lib/x86_64-linux-gnu/libssl.a /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/
          cp /usr/lib/x86_64-linux-gnu/libcrypto.a /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/

          # Set up pkg-config
          echo "=== Setting up pkg-config ==="
          export PKG_CONFIG_PATH="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
          export PKG_CONFIG_LIBDIR="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
          export PKG_CONFIG_SYSROOT_DIR="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot"

          # Create OpenSSL pkg-config files
                    cat > /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig/openssl.pc << EOF
          prefix=/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr
          exec_prefix=\${prefix}
          libdir=\${prefix}/lib
          includedir=\${prefix}/include

          Name: OpenSSL
          Description: Secure Sockets Layer and cryptography libraries
          Version: 1.1.1
          Requires: libssl libcrypto
          EOF

          cat > /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig/libssl.pc << EOF
          prefix=/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr
          exec_prefix=\${prefix}
          libdir=\${prefix}/lib
          includedir=\${prefix}/include

          Name: OpenSSL-libssl
          Description: Secure Sockets Layer and cryptography libraries - libssl
          Version: 1.1.1
          Requires: libcrypto
          Libs: -L\${libdir} -lssl
          Cflags: -I\${includedir}
          EOF

          cat > /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig/libcrypto.pc << EOF
          prefix=/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr
          exec_prefix=\${prefix}
          libdir=\${prefix}/lib
          includedir=\${prefix}/include

          Name: OpenSSL-libcrypto
          Description: OpenSSL cryptography library
          Version: 1.1.1
          Libs: -L\${libdir} -lcrypto
          Libs.private: -ldl -pthread
          Cflags: -I\${includedir}
          EOF

          # Debug information
          echo "=== System Information ==="
          uname -a
          echo "=== Compiler Information ==="
          ${CROSS_COMPILE}gcc --version
          echo "=== PKG Config Information ==="
          pkg-config --version
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
          echo "PKG_CONFIG_LIBDIR=$PKG_CONFIG_LIBDIR"
          echo "PKG_CONFIG_SYSROOT_DIR=$PKG_CONFIG_SYSROOT_DIR"
          echo "=== Environment Variables ==="
          env | sort
          echo "=== Directory Structure ==="
          ls -la /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/
          ls -la /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/include/
          ls -la /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig/

      - name: Make build script executable
        run: |
          chmod +x build_ffmpeg.sh

      - name: Run cross-compilation
        run: |
          export PKG_CONFIG_PATH="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
          export PKG_CONFIG_LIBDIR="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
          export PKG_CONFIG_SYSROOT_DIR="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot"
          export PKG_CONFIG_DEBUG_SPEW=1
          ./build_ffmpeg.sh

      - name: Check build artifacts
        run: |
          ls -la install/bin/
          file install/bin/ffmpeg
          ${CROSS_COMPILE}readelf -h install/bin/ffmpeg
          ldd install/bin/ffmpeg || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-armv6-static
          path: install/bin/
          if-no-files-found: error
