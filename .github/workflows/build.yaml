name: Build FFmpeg for Pi Zero

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: dockcross/linux-armv6:latest
      options: --platform linux/amd64  # Ensure container runs on x86_64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup environment
        run: |
          echo "Checking environment..."
          uname -a
          ${CROSS_COMPILE}gcc --version
          pkg-config --version

      - name: Make build script executable
        run: chmod +x build_ffmpeg.sh

      - name: Run cross-compilation
        run: ./build_ffmpeg.sh

      - name: Check build artifacts
        run: |
          ls -la install/bin/
          file install/bin/ffmpeg
          ${CROSS_COMPILE}readelf -h install/bin/ffmpeg

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-armv6-static
          path: install/bin/
          if-no-files-found: error
