name: Build FFmpeg for Pi Zero v6.0
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Cache dockcross wrapper
        uses: actions/cache@v3
        with:
          path: ./dockcross
          key: ${{ runner.os }}-dockcross-v1
          restore-keys: |
            ${{ runner.os }}-dockcross-
      - name: Download dockcross wrapper
        if: steps.cache.outputs.cache-hit != 'true'
        run: docker run --rm dockcross/linux-armv6 > ./dockcross

      - run: chmod +x dockcross build_ffmpeg.sh

      - name: Install build dependencies in dockcross
        run: |
          ./dockcross bash -lc "apt-get update && apt-get install -y --no-install-recommends \
          git pkg-config build-essential yasm libssl-dev libv4l-dev libdrm-dev zlib1g-dev \
          libjpeg-dev libpng-dev libx264-dev libavcodec-dev libavformat-dev libavfilter-dev \
          libavutil-dev libswscale-dev libswresample-dev \
          && rm -rf /var/lib/apt/lists/*"
      
      - name: Build inside dockcross
        run: ./dockcross ./build_ffmpeg.sh

      - uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-armv6
          path: ffmpeg-armv6.tar.gz
