name: ğŸ¬ Build FFmpeg for Raspberry Pi Zero ğŸ¥§

on: [workflow_dispatch]

jobs:
  build:
    name: ğŸš€ Cross-compile FFmpeg for ARMv6
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ—ï¸  Build with optimized Docker
        run: |
          echo "ğŸ—ï¸  =============== BUILDING WITH DOCKER ==============="
          echo "ğŸ“¦ Using multi-stage Dockerfile with cached dependencies..."
          
          # Build using the optimized Dockerfile with verbose output
          echo "ğŸ”§ Building Docker image..."
          if docker build --target output -t zeroffmpeg:latest . 2>&1; then
            echo "âœ… Docker build completed successfully!"
          else
            echo "âŒ Docker build failed!"
            echo "ğŸ” Trying to build intermediate stages for debugging..."
            docker build --target deps-builder -t debug-deps . || echo "âŒ deps-builder stage failed"
            docker build --target ffmpeg-builder -t debug-ffmpeg . || echo "âŒ ffmpeg-builder stage failed"
            exit 1
          fi
          
          echo "ğŸ“Š Docker build results:"
          docker images | grep zeroffmpeg

      - name: ğŸ“¤ Extract binaries from Docker
        run: |
          echo "ğŸ“¤ =============== EXTRACTING BINARIES ==============="
          
          # First, let's see if the Docker build was successful
          echo "ğŸ” Checking Docker images:"
          docker images | grep zeroffmpeg || echo "âŒ No zeroffmpeg image found"
          
          # Create temporary container (scratch image, no shell tools available)
          echo "ğŸ” Creating container from scratch-based image..."
          docker create --name temp-zeroffmpeg zeroffmpeg:latest
          echo "ğŸ“ Note: Using FROM scratch, so no internal inspection possible"
          
          # Try to extract binaries
          mkdir -p install/bin
          echo "ğŸ“¤ Attempting to extract ffmpeg..."
          if docker cp temp-zeroffmpeg:/ffmpeg install/bin/ffmpeg 2>/dev/null; then
            echo "âœ… ffmpeg extracted successfully"
          else
            echo "âŒ Failed to extract ffmpeg from /ffmpeg"
            echo "âš ï¸  Note: Cannot search inside scratch container (no find command)"
          fi
          
          echo "ğŸ“¤ Attempting to extract ffprobe..."
          if docker cp temp-zeroffmpeg:/ffprobe install/bin/ffprobe 2>/dev/null; then
            echo "âœ… ffprobe extracted successfully"
          else
            echo "âš ï¸  ffprobe not found (this is normal, we only build ffmpeg)"
          fi
          
          # Clean up
          docker rm temp-zeroffmpeg
          
          # Make binaries executable if they exist
          if [ -f install/bin/ffmpeg ]; then
            chmod +x install/bin/ffmpeg
            echo "âœ… Made ffmpeg executable"
          fi
          if [ -f install/bin/ffprobe ]; then
            chmod +x install/bin/ffprobe
            echo "âœ… Made ffprobe executable"
          fi
          
          echo "ğŸ“Š Final extraction results:"
          ls -la install/bin/ || echo "âŒ install/bin directory is empty"

      - name: ğŸ§ª Verify build artifacts
        run: |
          echo "ğŸ§ª =============== VERIFYING BUILD ARTIFACTS ==============="
          if [ -f "install/bin/ffmpeg" ]; then
            echo "âœ… FFmpeg binary found!"
            echo "ğŸ“Š Binary size: $(ls -lh install/bin/ffmpeg | awk '{print $5}')"
            echo "ğŸ—ï¸  Architecture: $(file install/bin/ffmpeg | grep -o 'ARM.*')"
            echo "ğŸ” ELF Header info:"
            readelf -h install/bin/ffmpeg | grep -E "(Class|Machine|Entry)" || echo "ğŸ“‹ ELF info not available"
            echo "ğŸ”— Dependencies check:"
            ldd install/bin/ffmpeg 2>/dev/null && echo "âš ï¸  Dynamic linking detected" || echo "âœ… Static binary confirmed"
          else
            echo "âŒ FFmpeg binary not found!"
            echo "ğŸ“ Available files in install/bin:"
            ls -la install/bin/ || echo "âŒ install/bin directory not found"
            exit 1
          fi
          
          if [ -f "install/bin/ffprobe" ]; then
            echo "âœ… FFprobe binary found!"
            echo "ğŸ“Š FFprobe size: $(ls -lh install/bin/ffprobe | awk '{print $5}')"
          else
            echo "âš ï¸  FFprobe binary not found"
          fi

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ğŸ¬-ffmpeg-armv6-static-ğŸ¥§
          path: install/bin/
          if-no-files-found: error
