name: ğŸ¬ Build FFmpeg for Raspberry Pi Zero ğŸ¥§

on: [workflow_dispatch]

jobs:
  build:
    name: ğŸš€ Cross-compile FFmpeg for ARMv6
    runs-on: ubuntu-latest
    container:
      image: dockcross/linux-armv6:latest
      options: --platform linux/amd64  # Ensure container runs on x86_64

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ =============== INSTALLING DEPENDENCIES ==============="
          apt-get update >/dev/null 2>&1
          apt-get install -y \
          automake \
          autoconf \
          build-essential \
          ccache \
          cmake \
          git \
          libasound2-dev \
          libdrm-dev \
          libgnutls28-dev \
          libjpeg-dev \
          libssl-dev \
          libv4l-dev \
          libx264-dev \
          libtool \
          make \
          nasm \
          openssl \
          pkg-config \
          sudo \
          yasm \
          zlib1g-dev >/dev/null 2>&1
          echo "âœ… All dependencies installed successfully"

      - name: ğŸ”§ Setup environment
        run: |
          echo "ğŸ”§ =============== SETTING UP ENVIRONMENT ==============="
          # Set up sysroot directories with proper permissions
          echo "ğŸ“ Creating sysroot directories..."
          sudo mkdir -p /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib
          sudo mkdir -p /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/include
          sudo mkdir -p /usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig
          sudo chmod -R 777 /usr/xcc/armv6-unknown-linux-gnueabihf

          # Set up pkg-config
          echo "ğŸ“¦ Setting up pkg-config..."
          export PKG_CONFIG_PATH="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
          export PKG_CONFIG_LIBDIR="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
          export PKG_CONFIG_SYSROOT_DIR="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot"

          # Debug information
          echo "ğŸ” =============== SYSTEM INFORMATION ==============="
          echo "ğŸ–¥ï¸  System: $(uname -m)"
          echo "ğŸ”§ Compiler: $(${CROSS_COMPILE}gcc --version | head -1)"
          echo "ğŸ“¦ PKG-Config: $(pkg-config --version)"
          echo "âœ… Environment setup complete"

      - name: ğŸ—ï¸  Make build script executable
        run: |
          echo "ğŸ—ï¸  Preparing build script..."
          chmod +x build_ffmpeg.sh
          echo "âœ… Build script ready"

      - name: âš™ï¸  Run cross-compilation
        run: |
          echo "âš™ï¸  =============== STARTING CROSS-COMPILATION ==============="
          export PKG_CONFIG_PATH="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
          export PKG_CONFIG_LIBDIR="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
          export PKG_CONFIG_SYSROOT_DIR="/usr/xcc/armv6-unknown-linux-gnueabihf/armv6-unknown-linux-gnueabihf/sysroot"
          ./build_ffmpeg.sh

      - name: ğŸ§ª Verify build artifacts
        run: |
          echo "ğŸ§ª =============== VERIFYING BUILD ARTIFACTS ==============="
          if [ -f "install/bin/ffmpeg" ]; then
            echo "âœ… FFmpeg binary found!"
            echo "ğŸ“Š Binary size: $(ls -lh install/bin/ffmpeg | awk '{print $5}')"
            echo "ğŸ—ï¸  Architecture: $(file install/bin/ffmpeg | grep -o 'ARM.*')"
            echo "ğŸ” ELF Header info:"
            ${CROSS_COMPILE}readelf -h install/bin/ffmpeg | grep -E "(Class|Machine|Entry)"
            echo "ğŸ”— Dependencies check:"
            ldd install/bin/ffmpeg 2>/dev/null && echo "âš ï¸  Dynamic linking detected" || echo "âœ… Static binary confirmed"
          else
            echo "âŒ FFmpeg binary not found!"
            echo "ğŸ“ Available files in install/bin:"
            ls -la install/bin/ || echo "âŒ install/bin directory not found"
            exit 1
          fi
          
          if [ -f "install/bin/ffprobe" ]; then
            echo "âœ… FFprobe binary found!"
            echo "ğŸ“Š FFprobe size: $(ls -lh install/bin/ffprobe | awk '{print $5}')"
          else
            echo "âš ï¸  FFprobe binary not found"
          fi

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ğŸ¬-ffmpeg-armv6-static-ğŸ¥§
          path: install/bin/
          if-no-files-found: error
